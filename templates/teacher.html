{% extends "basic.html" %}

{% block edit_button %}
<button class="user_info_element" id="edit_button" onclick="show_edit_block('edit_modal')">Редактировать</button>
{% endblock %}

{% block additional_userinfo %}
<p class="user_info_element" id="teacher_email">Email: {{ user_data.teacher.email }}</p>
<p class="user_info_element" id="teacher_phone">Телефон: {{ user_data.teacher.phone }}</p>
{% endblock %}


{% block add_groups %}
<div id="add_groups_modal" class="modal">
    <div class="modal-content">
        <h2>Добавить новые группы</h2>
        <textarea id="group_description" rows="4" cols="50" 
                  placeholder="Введите описание группы здесь..." 
                  class="modal-input"></textarea>
        <div class="modal-buttons">
            <button class="modal-button save" onclick="add_new_groups()">Добавить</button>
            <button class="modal-button cancel" onclick="hide_edit_block('add_groups_modal')">Закрыть</button>
        </div>
    </div>
</div>
{% endblock %}

{% block edit_userinfo %}
<div id="edit_modal" style="display: none;">
    <h2>Редактирование данных</h2>

    <label class="user_info">Имя: <input type="text" id="name"></label><br>
    <label class="user_info">Почта: <input type="email" id="email"></label><br>
    <label class="user_info">Телефон: <input type="tel" id="phone"></label><br>
    <button id="save_button" onclick="save_userdata()">Сохранить</button>
    <button id="close_button" onclick="hide_edit_block('edit_modal')">Закрыть</button>
</div>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{url_for('static', path='css/teacher.css')}}">
<link rel="stylesheet" href="{{url_for('static', path='css/teacher_tables.css')}}">
{% endblock %}

{% block main_content %}
<div class="course_block">
    <h1>Линейная алгебра</h1>
    <h3>Лабораторные работы</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th rowspan="2">Имя студента</th>
                    <th rowspan="2">Итог</th>
                    <th rowspan="2">Оценка</th>

                    <th colspan="{{ linal_labs_count }}">Работы</th>
                </tr>
                <tr>
                    {% for lab_number in range(1, linal_labs_count + 1) %}
                    <th>Работа {{lab_number}}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for group_name, students in all_groups_and_students %}
                <tr>
                    <th class="group-name" colspan="{{ linal_labs_count + 3 }}">{{group_name}}</th>
                </tr>
                    {% for student_with_res in students %}
                    <tr>
                        <td>{{student_with_res.name}}</td>
                        <td>{{student_with_res.total_linal_result}}/{{linal_labs_count}}</td>
                        <td class="student_finaly_result"></td>
                        {% for lab_number in range(1, linal_labs_count + 1) %}
                        <td class="mark-cell {% if not student_with_res.linal_marks[lab_number-1].approve_date %}deadline-missed{% elif student_with_res.linal_marks[lab_number-1].approve_date <= student_with_res.linal_deadlines[lab_number-1] %}deadline-met{% else %}deadline-late{% endif %}">
                            <div class="mark-content">
                                {{ student_with_res.linal_marks[lab_number-1].approve_date or "Не сдано" }}
                            </div>
                        </td>
                        {% endfor %} 
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="course_block" id="analytical-geometry-table">
    <h1>Аналитическая геометрия</h1>
    <h3>Лабораторные работы</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th rowspan="2">Имя студента</th>
                    <th rowspan="2">Итог</th>
                    <th rowspan="2">Оценка</th>  
                    <th colspan="{{ angem_labs_count }}">Работы</th>
                </tr>
                <tr>
                    {% for lab_number in range(1, angem_labs_count + 1) %}
                    <th>Работа {{lab_number}}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for group_name, students in all_groups_and_students %}
                <tr>
                    <th class="group-name" colspan="{{ angem_labs_count + 3 }}">{{group_name}}</th>
                </tr>
                    {% for student_with_res in students %}
                    <tr>
                        <td>{{student_with_res.name}}</td>
                        <td>{{student_with_res.total_angem_result}}/{{angem_labs_count}}</td>
                        <td class="student_finaly_result"></td>
                        {% for lab_number in range(1, angem_labs_count + 1) %}
                        <td class="mark-cell {% if not student_with_res.angem_marks[lab_number-1].approve_date %}deadline-missed{% elif student_with_res.angem_marks[lab_number-1].approve_date <= student_with_res.angem_deadlines[lab_number-1] %}deadline-met{% else %}deadline-late{% endif %}">
                            <div class="mark-content">
                                {{ student_with_res.angem_marks[lab_number-1].approve_date or "Не сдано" }}
                            </div>
                        </td>
                        {% endfor %}

                        
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<button class="add_groups_button" onclick="show_edit_block('add_groups_modal')">Добавить новые группы</button>
{% endblock %}


{% block end_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function calculateGrade(points) {
        if (points >= 25) return 'отл';
        if (points >= 16) return 'хор';
        if (points >= 8) return 'удовл';
        return 'неуд';
    }

    function processTable(table) {
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (row.querySelector('.group-name')) return;
            
            let totalPoints = 0;
            
            // Обрабатываем все ячейки с оценками (начиная с 4-й)
            for (let i = 3; i < row.cells.length; i++) {
                const cell = row.cells[i];
                
                if (cell.classList.contains('mark-cell')) {
                    if (cell.classList.contains('deadline-met')) {
                        totalPoints += 2;
                    } else if (cell.classList.contains('deadline-late')) {
                        totalPoints += 1;
                    }
                }
            }
            
            const gradeCell = row.cells[2];
            const grade = calculateGrade(totalPoints);
            
            gradeCell.className = 'grade-cell grade-' + grade;
            gradeCell.textContent = grade;
            gradeCell.style.fontWeight = 'bold';
        });
    }

    function processAllTables() {
        const tables = document.querySelectorAll('.course_block table');
        
        tables.forEach(table => {
            if (table && table.querySelector('td')) {
                processTable(table);
                const markCells = table.querySelectorAll('.mark-cell');
                markCells.forEach(cell => {
                    if (!cell.classList.contains('deadline-met') && 
                        !cell.classList.contains('deadline-late')) {
                        cell.classList.add('deadline-missed');
                    }
                });
            }
        });
    }
    // Запускаем обработку
    setTimeout(processAllTables, 50);
    window.addEventListener('resize', processAllTables);
});
</script>
{% endblock %}

